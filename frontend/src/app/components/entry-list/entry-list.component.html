<!-- frontend/src/app/components/entry-list/entry-list.component.html -->

<!-- The user variable is now sourced from the component property `currentUser` -->
<div class="image-list-container" *ngIf="currentUser$ | async as user">

  <!-- Header Section -->
  <div class="header-bar">
    <div class="header">
      <!-- UPDATED: "Images in" to "Entries in" -->
      <h2 *ngIf="dbName">Entries in: {{ dbName }}</h2>
      <h2 *ngIf="!dbName">Select a Database</h2>
    </div>
    
    <!-- View Mode Toggle -->
    <!-- UPDATED: Fixed `class.` typo to `class=` -->
    <div class="view-mode-toggle" *ngIf="dbName">
      <button 
        class="toggle-btn"
        [class.active]="viewMode === 'grid'"
        (click)="setViewMode('grid')"
        title="Grid View">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 11a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
      </button>
      <button
        class="toggle-btn"
        [class.active]="viewMode === 'list'"
        (click)="setViewMode('list')"
        title="List View">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
      </button>
    </div>
  </div>

  <ng-container *ngIf="dbName; else noDbSelected">

    <!-- Filter Bar (Stays in parent component) -->
    <div class="filter-bar">
      <form [formGroup]="filterForm" (ngSubmit)="applyFilters()">
        <div class="filter-controls">
          <!-- Standard Filters -->
          <div class="form-group">
            <label for="tstart" class="form-label">Start Date</label>
            <input id="tstart" type="datetime-local" formControlName="tstart" class="form-control">
          </div>
          <div class="form-group">
            <label for="tend" class="form-label">End Date</label>
            <input id="tend" type="datetime-local" formControlName="tend" class="form-control">
          </div>
          <div class="form-group limit-group">
            <!-- UPDATED: "Limit" to "Per Page" -->
            <label for="limitPerPage" class="form-label">Per Page</label>
            <!-- UPDATED: formControlName to "limitPerPage" -->
            <input id="limitPerPage" type="number" formControlName="limitPerPage" class="form-control">
             <div *ngIf="filterForm.get('limitPerPage')?.invalid && (filterForm.get('limitPerPage')?.dirty || filterForm.get('limitPerPage')?.touched)" class="form-error">
                 Limit required (min 1).
             </div>
          </div>
          <!-- Dynamic Custom Field Filters -->
          <div formArrayName="customFilters" class="custom-filters-array">
            <div *ngFor="let group of customFilters.controls; let i = index" [formGroupName]="i" class="custom-filter-row">
              <select formControlName="field" class="form-control">
                <option value="">-- Select Field --</option>
                <option *ngFor="let field of availableFilters" [value]="field.name">{{ field.name }}</option>
              </select>
              <select formControlName="operator" class="form-control">
                 <ng-container *ngIf="getSelectedFieldType(i) as fieldType">
                    <option *ngFor="let op of getOperatorsForFieldType(fieldType)" [value]="op === 'LIKE' ? 'LIKE' : op">
                        {{ op === 'LIKE' ? 'contains' : op }}
                    </option>
                 </ng-container>
                 <ng-container *ngIf="!getSelectedFieldType(i)">
                    <option value="=">=</option>
                    <option value="!=">!=</option>
                 </ng-container>
              </select>
              <input type="text" formControlName="value" placeholder="Value" class="form-control">
              <button type="button" class="btn-remove" (click)="removeCustomFilter(i)" title="Remove Filter">
                <svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
              </button>
            </div>
          </div>
          <!-- Filter Actions -->
          <div class="filter-actions">
            <button type="button" class="btn-link" (click)="addCustomFilter()">+ Add Filter</button>
            <button type="submit" class="btn btn-primary" [disabled]="filterForm.invalid">Apply</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Main Content: Child Components or State Messages -->
    <div class="content-area">
      <div *ngIf="isLoading" class="state-message">
        <!-- UPDATED: "images" to "entries" -->
        <p>Loading entries...</p>
      </div>

      <ng-container *ngIf="!isLoading">
        <!-- UPDATED: Check entriesToShow.length -->
        <ng-container *ngIf="entriesToShow.length > 0; else emptyState">

          <!-- *** REPLACED WITH CHILD COMPONENTS *** -->

          <!-- VIEW 1: List View (Table) -->
          <!-- UPDATED: Pass entriesToShow, rename component selector -->
          <app-entry-list-view
            *ngIf="viewMode === 'list'"
            [entries]="entriesToShow"
            [tableColumns]="tableColumns"
            [user]="currentUser"
            [dbName]="dbName"
            (entryClicked)="openDetailModal($event)"
            (editClicked)="openEditModal($event)"
            (deleteClicked)="openDeleteConfirm($event)">
          </app-entry-list-view>

          <!-- VIEW 2: Grid View -->
          <!-- UPDATED: Pass entriesToShow, rename component selector -->
          <app-entry-grid
            *ngIf="viewMode === 'grid'"
            [entries]="entriesToShow"
            [dbName]="dbName"
            (entryClicked)="openDetailModal($event)">
          </app-entry-grid>
          
          <!-- Pagination Controls (Stays in parent) -->
          <!-- UPDATED: Logic for backend pagination -->
          <div class="pagination-controls" *ngIf="currentPage > 1 || hasNextPage">
            <button (click)="prevPage()" *ngIf="currentPage > 1" class="btn btn-secondary">
              &larr; Previous
            </button>
            
            <span class="page-indicator">Page {{ currentPage }}</span>
            
            <button (click)="nextPage()" *ngIf="hasNextPage" class="btn btn-secondary">
              Next &rarr;
            </button>
          </div>

        </ng-container>

        <ng-template #emptyState>
          <div class="state-message">
            <!-- UPDATED: "images" to "entries" -->
            <p>No entries found that match the current filters.</p>
          </div>
        </ng-template>
      </ng-container>
    </div>

    <!-- Floating Action Button (Stays in parent) -->
    <button
      *ngIf="user.can_create"
      class="btn btn-primary upload-fab"
      (click)="openUploadModal()"
      title="Upload New Entry"> <!-- UPDATED: title -->
      <svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>

  </ng-container>

  <ng-template #noDbSelected>
    <div class="state-message">
      <!-- UPDATED: "images" to "entries" -->
      <p>Please select a database from the sidebar to view its entries.</p>
    </div>
  </ng-template>

</div>

