<div class="image-list-container" 
     *ngIf="currentUser$ | async as user"
     appFileDragDrop
     (fileDropped)="onFileDropped($event)">

  <div class="header-bar">
    <div class="header">
      <h2 *ngIf="dbName">Entries in: {{ dbName }}</h2>
      <h2 *ngIf="!dbName">Select a Database</h2>
    </div>
    
    <div class="view-mode-toggle" *ngIf="dbName">
      <button 
        class="toggle-btn"
        [class.active]="viewMode === 'grid'"
        (click)="setViewMode('grid')"
        title="Grid View">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 11a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
      </button>
      <button
        class="toggle-btn"
        [class.active]="viewMode === 'list'"
        (click)="setViewMode('list')"
        title="List View">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
      </button>
    </div>
  </div>

  <ng-container *ngIf="dbName; else noDbSelected">

    <!-- REFACTORED: Use the new EntryFilterComponent -->
    <app-entry-filter
      [availableFilters]="availableFilters"
      [isLoading]="isLoading"
      (filterApplied)="onFilterApplied($event)">
    </app-entry-filter>

    <div class="content-area">
      <div *ngIf="isLoading" class="state-message">
        <p>Loading entries...</p>
      </div>

      <ng-container *ngIf="!isLoading">
        <ng-container *ngIf="entriesToShow.length > 0; else emptyState">

          <app-entry-list-view
            *ngIf="viewMode === 'list'"
            [entries]="entriesToShow"
            [tableColumns]="tableColumns"
            [user]="currentUser"
            [dbName]="dbName"
            [selectedIds]="selectedEntryIds"
            (entryClicked)="openDetailModal($event)"
            (editClicked)="openEditModal($event)"
            (deleteClicked)="openDeleteConfirm($event)"
            (toggleSelection)="toggleSelection($event)">
          </app-entry-list-view>

          <app-entry-grid
            *ngIf="viewMode === 'grid'"
            [entries]="entriesToShow"
            [dbName]="dbName"
            [selectedIds]="selectedEntryIds"
            (entryClicked)="openDetailModal($event)"
            (toggleSelection)="toggleSelection($event)">
          </app-entry-grid>
          
          <div class="pagination-controls" *ngIf="currentPage > 1 || hasNextPage">
            <button (click)="prevPage()" *ngIf="currentPage > 1" class="btn btn-secondary">
              &larr; Previous
            </button>
            <span class="page-indicator">Page {{ currentPage }}</span>
            <button (click)="nextPage()" *ngIf="hasNextPage" class="btn btn-secondary">
              Next &rarr;
            </button>
          </div>

        </ng-container>

        <ng-template #emptyState>
          <div class="state-message">
            <p>No entries found that match the current filters.</p>
          </div>
        </ng-template>
      </ng-container>
    </div>

    <!-- FLOATING ACTIONS -->
    <div class="floating-actions-wrapper">
      <div class="selection-actions" *ngIf="selectedEntryIds.size > 0">
        <span class="selection-count">{{ selectedEntryIds.size }} selected</span>
        <button class="btn btn-secondary btn-sm" (click)="clearSelection()">Cancel</button>
        
        <button 
          *ngIf="user.can_delete"
          class="btn btn-danger btn-icon" 
          (click)="onBulkDelete()"
          [disabled]="isBulkProcessing"
          title="Delete Selected">
          <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
        </button>

        <button 
          class="btn btn-primary btn-icon"
          (click)="onBulkDownload()"
          [disabled]="isBulkProcessing"
          title="Download Selected">
          <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        </button>
      </div>

      <button
        *ngIf="user.can_create"
        class="btn btn-primary upload-fab"
        (click)="openUploadModal()"
        title="Upload New Entry">
        <svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </button>
    </div>

  </ng-container>

  <ng-template #noDbSelected>
    <div class="state-message">
      <p>Please select a database from the sidebar to view its entries.</p>
    </div>
  </ng-template>
</div>