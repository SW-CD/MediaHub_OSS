<!-- frontend/src/app/components/upload-entry-modal/upload-entry-modal.component.html -->

<!-- UPDATED: Title and ID -->
<app-modal [modalId]="'uploadEntryModal'" [modalTitle]="'Upload Entry to ' + (currentDatabase?.name || '')">
  <!-- Show form only if the database context is loaded -->
  <div *ngIf="currentDatabase && uploadForm">
    <form [formGroup]="uploadForm" (ngSubmit)="onSubmit()">

      <!-- File Input (Custom Styled) -->
      <div class="form-group">
        <!-- UPDATED: "Image File" to "File" -->
        <label for="file" class="form-label">File</label>
        
        <!-- Custom file input wrapper -->
        <div class="form-file-input">
          <!-- The actual file input, hidden. -->
          <!-- UPDATED: id, formControlName, #fileInput, [accept] binding -->
          <input 
            id="file" 
            type="file" 
            (change)="onFileSelected($event)" 
            [accept]="fileAcceptString"
            formControlName="file"
            #fileInput>
          
          <!-- Label to display the selected file name -->
          <label for="file" class="file-label">{{ selectedFileName || 'No file chosen' }}</label>
          
          <!-- Button to trigger the hidden file input. -->
          <button type="button" class="file-browse-btn" (click)="fileInput.click()">Browse...</button>
        </div>
        
        <!-- Validation Error -->
        <!-- UPDATED: formControlName to 'file' -->
        <div *ngIf="uploadForm.get('file')?.invalid && uploadForm.get('file')?.touched" class="form-error">
          A file is required.
        </div>
      </div>

      <!-- Standard Metadata: Timestamp -->
      <div class="form-group">
        <label for="timestamp" class="form-label">Timestamp</label>
        <input id="timestamp" type="datetime-local" formControlName="timestamp" class="form-control">
      </div>

      <!-- Custom Metadata Section -->
      <div *ngIf="currentDatabase.custom_fields.length > 0" class="custom-fields-section">
        <h4>Custom Metadata</h4>
        <div class="form-grid">
          
          <!-- Loop through all custom fields -->
          <div *ngFor="let field of currentDatabase.custom_fields" class="form-group">
            
            <!-- Use ngSwitch to render the correct control based on field type -->
            <ng-container [ngSwitch]="field.type">

              <!-- Case 1: BOOLEAN (Render the new toggle switch) -->
              <ng-container *ngSwitchCase="'BOOLEAN'">
                <label [for]="field.name" class="form-label">{{ field.name }} (BOOLEAN)</label>
                
                <!-- Container for the switch and its text value -->
                <div class="bool-field-container">
                  <!-- The Toggle Switch -->
                  <label class="toggle-switch">
                    <input type="checkbox" [id]="field.name" [formControlName]="field.name">
                    <span class="toggle-slider"></span>
                  </label>
                  
                  <!-- Display the current value (True/False) -->
                  <span class="bool-field-value">
                    {{ uploadForm.get(field.name)?.value ? 'True' : 'False' }}
                  </span>
                </div>
              </ng-container>

              <!-- Case 2: All other types (Default label-and-input layout) -->
              <ng-container *ngSwitchDefault>
                <label [for]="field.name" class="form-label">{{ field.name }} ({{ field.type }})</label>
                
                <!-- Nested switch for the input element itself -->
                <ng-container [ngSwitch]="field.type">
                  <input *ngSwitchCase="'INTEGER'"
                         [id]="field.name"
                         type="number"
                         step="1"
                         [formControlName]="field.name"
                         class="form-control">
                  
                  <input *ngSwitchCase="'REAL'"
                         [id]="field.name"
                         type="number"
                         step="any"
                         [formControlName]="field.name"
                         class="form-control">
                  
                  <!-- Default is TEXT -->
                  <input *ngSwitchDefault
                         [id]="field.name"
                         type="text"
                         [formControlName]="field.name"
                         class="form-control">
                </ng-container>
              </ng-container>

            </ng-container>
          </div>
          <!-- End of *ngFor loop -->

        </div>
      </div>

      <!-- Modal Actions -->
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary" [disabled]="uploadForm.invalid || isLoading">
          {{ isLoading ? 'Uploading...' : 'Upload' }}
        </button>
      </div>

    </form>
  </div>

  <!-- Fallback if database isn't loaded -->
  <div *ngIf="!currentDatabase">
    <p>Please select a database first before uploading an entry.</p>
  </div>
</app-modal>
